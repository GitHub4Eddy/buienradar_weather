{"name":"Buienradar_Weather","type":"com.fibaro.weather","apiVersion":"1.2","initialProperties":{"viewLayout":{"$jason":{"body":{"header":{"style":{"height":"0"},"title":"quickApp_device_411"},"sections":{"items":[{"components":[{"name":"labelStationname","style":{"weight":"1.2"},"text":"Station","type":"label"},{"style":{"weight":"0.5"},"type":"space"}],"style":{"weight":"1.2"},"type":"vertical"},{"components":[{"name":"labelWeatherdescription","style":{"weight":"1.2"},"text":"Weatherdescription","type":"label"},{"style":{"weight":"0.5"},"type":"space"}],"style":{"weight":"1.2"},"type":"vertical"},{"components":[{"name":"labelTemperature","style":{"weight":"1.2"},"text":"Temperature","type":"label"},{"style":{"weight":"0.5"},"type":"space"}],"style":{"weight":"1.2"},"type":"vertical"},{"components":[{"name":"labelHumidity","style":{"weight":"1.2"},"text":"Humidity","type":"label"},{"style":{"weight":"0.5"},"type":"space"}],"style":{"weight":"1.2"},"type":"vertical"},{"components":[{"name":"labelWind","style":{"weight":"1.2"},"text":"Wind","type":"label"},{"style":{"weight":"0.5"},"type":"space"}],"style":{"weight":"1.2"},"type":"vertical"}]}},"head":{"title":"quickApp_device_411"}}},"uiCallbacks":[],"quickAppVariables":[{"name":"Interval","value":"601"},{"name":"StationID","value":"6260"},{"name":"Timeout","value":"5"},{"name":"SetGlobalVar","value":"false"}],"typeTemplateInitialized":true},"files":[{"name":"main","isMain":true,"isOpen":true,"content":"-- QuickApp BUIENRADAR WEATHER \n\n-- The current observations are measured by KNMI weather stations spread across the country and are updated every 10 minutes. The weather report is updated several times a day by the Buienradar meteorologists.\n\n-- JSON data copyright: (C)opyright Buienradar / RTL. All rights reserved\n-- JSON data terms: This feed may be used freely under condition of source reference buienradar.nl including a hyperlink to https://www.buienradar.nl. The feed cannot be derived from users or other persons.\n\n\n-- Version 0.4 (23rd August 2020) \n   -- Completely renewed code\n   -- Several Global Variables are available for personal use\n   -- Addes QuickApp variable SetGlobalVar true or false, whether you want to use the Global Variables\n   -- Added QuickApp variable Timeout for finetuning waiting for response\n\n-- Version 0.3 (11th August 2020)\n   -- error message instead of debug message in case of an error\n   -- Changed method of adding QuickApp variables, so they can be edited\n\n-- Properties temperature, humidity and wind speed have the Buienradar values. This QuickApp can be used as your weather provider. \n-- conditionCodes = {unknown = 3200, clear = 32, rain = 40, snow = 38, storm = 666, cloudy = 30, fog = 20,}\n\n-- Station ID's and Stations: \n-- 6391 Meetstation Arcen / 6275 Meetstation Arnhem / 6249 Meetstation Berkhout / 6308 Meetstation Cadzand / 6260 Meetstation De Bilt / 6235 Meetstation Den Helder / 6370 Meetstation Eindhoven / 6377 Meetstation Ell / 6321 Meetstation Euro platform / 6350 Meetstation Gilze Rijen / 6323 Meetstation Goes / 6283 Meetstation Groenlo-Hupsel / 6280 Meetstation Groningen / 6315 Meetstation Hansweert /  6278 Meetstation Heino /  6356 Meetstation Herwijnen /  6330 Meetstation Hoek van Holland /  6279 Meetstation Hoogeveen / 6251 Meetstation Hoorn Terschelling /  6258 Meetstation Houtribdijk / 6285 Meetstation Huibertgat / 6209 Meetstation IJmond /  6225 Meetstation IJmuiden /  6277 Meetstation Lauwersoog / 6320 Meetstation LE Goeree / 6270 Meetstation Leeuwarden / 6269 Meetstation Lelystad / 6348 Meetstation Lopik-Cabauw / 6380 Meetstation Maastricht / 6273 Meetstation Marknesse / 6286 Meetstation Nieuw Beerta / 6312 Meetstation Oosterschelde / 6344 Meetstation Rotterdam / 6343 Meetstation Rotterdam Geulhaven / 6316 Meetstation Schaar / 6240 Meetstation Schiphol / 6324 Meetstation Stavenisse / 6267 Meetstation Stavoren / 6229 Meetstation Texelhors / 6331 Meetstation Tholen / 6290 Meetstation Twente / 6313 Meetstation Vlakte aan de Raan / 6242 Meetstation Vlieland / 6310 Meetstation Vlissingen / 6375 Meetstation Volkel / 6215 Meetstation Voorschoten / 6319 Meetstation Westdorpe / 6248 Meetstation Wijdenes / 6257 Meetstation Wijk aan Zee / 6340 Meetstation Woensdrecht / 6239 Meetstation Zeeplatform F-3 / 6252 Meetstation Zeeplatform K13\n\n-- Variables mandatory:\n-- Interval = Number in seconds to update the data\n-- Timeout = Number in seconds to wait for a response \n-- StationID = Number of the station you want to use for weather measurements\n-- SetGlobalVar = true or false, whether you want tu use the Global Variables\n\n-- This QuickApp can store all general and station specific weather information in global variables. These global variables you can use in your own scripts, for example to send an email every morning with the weather forecast, send notifications of weather changes, etcetera. \n\n-- Global Variables:\n   -- Buienradar_Shortterm_[deviceID]\n   -- Buienradar_Longterm_[deviceID]\n   -- Buienradar_Fivedayforecast_1_[deviceID]\n   -- Buienradar_Fivedayforecast_2_[deviceID]\n   -- Buienradar_Fivedayforecast_3_[deviceID]\n   -- Buienradar_Fivedayforecast_4_[deviceID]\n   -- Buienradar_Fivedayforecast_5_[deviceID]\n   -- Buienradar_Weatherreport_[deviceID]\n   -- Buienradar_Station_[deviceID]\n\n-- Examples of the Global Variables:\n \n   -- Buienradar_Shortterm_[deviceID] -- {\"startdate\":\"2020-08-23T00:00:00\",\"enddate\":\"2020-08-27T00:00:00\",\"forecast\":\"Onbestendig met geregeld regen of enkele buien.\",\"$id\":\"58\"}\n\n   -- Buienradar_Longterm_[deviceID] -- {\"startdate\":\"2020-08-28T00:00:00\",\"enddate\":\"2020-09-01T00:00:00\",\"forecast\":\"Aanvankelijk onbestendig met maxima iets onder het langjarig gemiddelde. Later in de periode neemt de kans op een droger en warmer weertype toe.\",\"$id\":\"59\"}\n\n   -- Buienradar_Fivedayforecast_1_[deviceID] -- {\"iconurl\":\"https:\\/\\/www.buienradar.nl\\/resources\\/images\\/icons\\/weather\\/30x30\\/f.png\",\"mintemperatureMin\":15,\"maxtemperatureMax\":21,\"weatherdescription\":\"Afwisselend bewolkt met (mogelijk) wat lichte regen\",\"mintemperature\":\"15\",\"mintemperatureMax\":15,\"mmRainMax\":5.0,\"maxtemperature\":\"21\",\"maxtemperatureMin\":21,\"wind\":4,\"windDirection\":\"w\",\"mmRainMin\":1.0,\"sunChance\":40,\"day\":\"2020-08-23T00:00:00\",\"rainChance\":50,\"$id\":\"60\"}\n \n   -- Buienradar_Fivedayforecast_2_[deviceID] -- {\"iconurl\":\"https:\\/\\/www.buienradar.nl\\/resources\\/images\\/icons\\/weather\\/30x30\\/f.png\",\"mintemperatureMin\":14,\"maxtemperatureMax\":20,\"weatherdescription\":\"Afwisselend bewolkt met (mogelijk) wat lichte regen\",\"mintemperature\":\"14\\/15\",\"mintemperatureMax\":15,\"mmRainMax\":5.0,\"maxtemperature\":\"19\\/20\",\"maxtemperatureMin\":19,\"wind\":3,\"windDirection\":\"w\",\"mmRainMin\":2.0,\"sunChance\":30,\"day\":\"2020-08-24T00:00:00\",\"rainChance\":70,\"$id\":\"61\"}\n \n   -- Buienradar_Fivedayforecast_3_[deviceID] -- {\"iconurl\":\"https:\\/\\/www.buienradar.nl\\/resources\\/images\\/icons\\/weather\\/30x30\\/f.png\",\"mintemperatureMin\":13,\"maxtemperatureMax\":22,\"weatherdescription\":\"Afwisselend bewolkt met (mogelijk) wat lichte regen\",\"mintemperature\":\"13\\/15\",\"mintemperatureMax\":15,\"mmRainMax\":6.0,\"maxtemperature\":\"20\\/22\",\"maxtemperatureMin\":20,\"wind\":4,\"windDirection\":\"zw\",\"mmRainMin\":2.0,\"sunChance\":30,\"day\":\"2020-08-25T00:00:00\",\"rainChance\":80,\"$id\":\"62\"}\n \n   -- Buienradar_Fivedayforecast_4_[deviceID] -- {\"iconurl\":\"https:\\/\\/www.buienradar.nl\\/resources\\/images\\/icons\\/weather\\/30x30\\/f.png\",\"mintemperatureMin\":16,\"maxtemperatureMax\":21,\"weatherdescription\":\"Afwisselend bewolkt met (mogelijk) wat lichte regen\",\"mintemperature\":\"16\\/17\",\"mintemperatureMax\":17,\"mmRainMax\":3.0,\"maxtemperature\":\"19\\/21\",\"maxtemperatureMin\":19,\"wind\":5,\"windDirection\":\"w\",\"mmRainMin\":1.0,\"sunChance\":30,\"day\":\"2020-08-26T00:00:00\",\"rainChance\":60,\"$id\":\"63\"}\n\n   -- Buienradar_Fivedayforecast_5_[deviceID] -- {\"iconurl\":\"https:\\/\\/www.buienradar.nl\\/resources\\/images\\/icons\\/weather\\/30x30\\/f.png\",\"mintemperatureMin\":13,\"maxtemperatureMax\":20,\"weatherdescription\":\"Afwisselend bewolkt met (mogelijk) wat lichte regen\",\"mintemperature\":\"13\\/15\",\"mintemperatureMax\":15,\"mmRainMax\":3.0,\"maxtemperature\":\"19\\/20\",\"maxtemperatureMin\":19,\"wind\":3,\"windDirection\":\"zw\",\"mmRainMin\":1.0,\"sunChance\":40,\"day\":\"2020-08-27T00:00:00\",\"rainChance\":70,\"$id\":\"64\"}\n\n   -- Buienradar_Weatherreport_[deviceID] -- {\"published\":\"2020-08-22T10:00:00\",\"authorbio\":\"Sinds 2017 als junior Meteoroloog actief voor het weekendteam van Buienradar. Daarnaast student van de Bachelor Bodem, Water & Atmosfeer aan de Wageningen Universiteit.\",\"author\":\"Philippe Schambergen\",\"text\":\"Na de warmte van de afgelopen weken gaat het roer nu flink om. De komende tijd is het wisselvallig in Nederland met normale temperaturen en vooral op woensdag staat er veel wind.Vandaag is het wisselend bewolkt en is het in het binnenland nog geruime tijd droog. In de loop van de dag gaan er vanuit het noordwesten buien vallen met in het noorden kans op onweer. Na het middaguur trekken deze buien verder landinwaarts. Tussen de buien door blijft er echter genoeg ruimte voor de zon. Het wordt 21 of 22 graden langs de kust en nog een zomerse 25 graden in het zuidoosten. Er staat een matige en aan zee krachtige zuidwestenwind, windkracht 4 tot 6. Ook komen er in heel het land windstoten rond de 50 km\\/h voor, tijdens buien mogelijk oplopend tot 75 km\\/h. Aan het eind van de middag komt er langs de zuidwestkust mogelijk een harde zuidwestenwind te staan, windkracht 7.Vanavond klaart het op en trekken de meeste buien naar het oosten weg. Het blijft nog even stevig waaien. Vannacht neemt de wind in het binnenland iets af en verdwijnen daar de windstoten. Er gaan wel opnieuw buien ontstaan in het noorden van het land. Het koelt af naar 17 graden aan zee en 14 graden in het binnenland.&nbsp;Morgen is het wisselend bewolkt en trekken enkele buien over het land. Er staat wel iets minder wind dan vandaag: de westenwind waait matig tot aan zee (vrij) krachtig. In de middag wordt het nog maar 20 graden op de Wadden en 22 graden in het zuidoosten van het land, waarmee de temperatuur rond normaal komt te liggen.De dagen erna is het wisselvallig met enkele buien waarbij het vooral in het noorden soms flink kan doorregenen. Een depressie ligt woensdag boven de Noordzee en deze zorgt dan voor een flinke toename van de wind. Mogelijk wordt het zelfs even stormachtig! In de middag wordt het 19 tot 22 graden, alleen dinsdag kan het in het zuidoosten wel weer 24 graden worden.\",\"title\":\"Terug naar normaal\",\"summary\":\"Na de warmte van de afgelopen weken gaat het roer nu flink om. De komende tijd is het wisselvallig in Nederland met normale temperaturen en vooral op woensdag staat er veel wind.\",\"$id\":\"57\"}\n\n   -- Buienradar_Station_[deviceID] -- {\"regio\":\"Rotterdam\",\"timestamp\":\"2020-08-22T11:40:00\",\"airpressure\":1013.1,\"lat\":51.95,\"weatherdescription\":\"Zwaar bewolkt\",\"rainFallLast24Hour\":0.6,\"feeltemperature\":20.3,\"precipitation\":0.0,\"stationname\":\"Meetstation Rotterdam\",\"lon\":4.45,\"$id\":\"36\",\"temperature\":20.3,\"graphUrl\":\"https:\\/\\/www.buienradar.nl\\/nederland\\/weerbericht\\/weergrafieken\\/c\",\"windgusts\":14.4,\"sunpower\":349.0,\"rainFallLastHour\":0.0,\"winddirection\":\"ZW\",\"stationid\":6344,\"groundtemperature\":20.7,\"winddirectiondegrees\":215,\"humidity\":68.0,\"windspeedBft\":5,\"windspeed\":9.3,\"visibility\":25300.0,\"iconurl\":\"https:\\/\\/www.buienradar.nl\\/resources\\/images\\/icons\\/weather\\/30x30\\/c.png\"}\n\n\n-- Below here no changes are needed\n\n\n-- Fill the Buienradar Global Variable\nfunction QuickApp:setGlobalVariable(tag,res)\n   --self:debug(\"res: \",json.encode(res))\n   if setglobalvar == \"true\" then \n      if api.get(\"/globalVariables/\"..tag) == nil then\n         local responseData, status = api.post(\"/globalVariables/\",{value=(json.encode(res)),name=tag})\n         self:trace(\"Global Variable created: \" ..tag ..\" / status: \" ..status) \n      else\n         local responseData, status = api.put(\"/globalVariables/\"..tag,{value=(json.encode(res))})\n         --self:trace(\"Global Variable updated: \" ..tag ..\" / status: \" ..status)\n      end\n   else\n      if api.get(\"/globalVariables/\"..tag) then\n         self:deleteGlobalVariable(tag) -- If the Global Variable exists, delete it\n      end\n   end\nend\n\n\n-- Delete the Buienradar Global Variable \nfunction QuickApp:deleteGlobalVariable(tag)\n   local responseData, status = api.delete(\"/globalVariables/\"..tag) \n   self:trace(\"Global Variable deleted: \" ..tag ..\" / status: \" ..status)\nend\n\n\n-- Set Weathercondition\nfunction QuickApp:setWeathercondition()\n   -- Update Condition (to be completed)\n   if weatherdescription == \"Zwaar bewolkt\" or weatherdescription == \"Mix van opklaringen en middelbare of lage bewolking\" then self:setCondition(\"cloudy\")\n   elseif weatherdescription == \"Zwaar bewolkt en regen\" then self:setCondition(\"rain\")\n   elseif weatherdescription == \"Vrijwel onbewolkt (zonnig/helder)\" then self:setCondition(\"clear\")\n   elseif weatherdescription == \"Sneeuw\" then self:setCondition(\"snow\")\n   elseif weatherdescription == \"Storm\" then self:setCondition(\"storm\")\n   elseif weatherdescription == \"Mistig\" then self:setCondition(\"fog\")\n   else -- Unable to set the Condition to a known one\n      self:setCondition(\"unknown\") \n      self:warning(\"Weatherdescription \" ..weatherdescription ..\" unknown\")\n   end\nend\n\n\n-- Update weather condition, update properties \"ConditionCode\" and \"WeatherCondition\"\nfunction QuickApp:setCondition(condition)\n   conditionCodes = {unknown = 3200, clear = 32, rain = 40, snow = 38, storm = 666, cloudy = 30, fog = 20,}\n   conditionCode = conditionCodes[condition]\n   condition = condition\n   if conditionCode then\n      self:updateProperty(\"ConditionCode\", conditionCode)\n      self:updateProperty(\"WeatherCondition\", condition)\n   end\nend\n\n\n-- Fetch all weather data from Buienradar url\nfunction QuickApp:getWeatherData()\n   local url = \"https://data.buienradar.nl/2.0/feed/json\"\n   --self:debug(\"Connecting: \", url)\n   http:request(url, {\n      options={\n         method = 'GET'\n      },\n      success = function(response)\n         --self:debug(\"response status:\", response.status)\n         --self:debug(\"headers:\", response.headers[\"Content-Type\"])\n         --self:debug(\"Response: \"..response.data) \n         local jsonTable = json.decode(response.data)\n\n         -- Save generiek weather values to Global Variables\n         self:setGlobalVariable(\"Buienradar_Shortterm_\"..plugin.mainDeviceId,jsonTable.forecast.shortterm)\n         self:setGlobalVariable(\"Buienradar_Longterm_\"..plugin.mainDeviceId,jsonTable.forecast.longterm)\n         self:setGlobalVariable(\"Buienradar_Fivedayforecast_1_\"..plugin.mainDeviceId,jsonTable.forecast.fivedayforecast[1])\n         self:setGlobalVariable(\"Buienradar_Fivedayforecast_2_\"..plugin.mainDeviceId,jsonTable.forecast.fivedayforecast[2])\n         self:setGlobalVariable(\"Buienradar_Fivedayforecast_3_\"..plugin.mainDeviceId,jsonTable.forecast.fivedayforecast[3])\n         self:setGlobalVariable(\"Buienradar_Fivedayforecast_4_\"..plugin.mainDeviceId,jsonTable.forecast.fivedayforecast[4])\n         self:setGlobalVariable(\"Buienradar_Fivedayforecast_5_\"..plugin.mainDeviceId,jsonTable.forecast.fivedayforecast[5])\n         self:setGlobalVariable(\"Buienradar_Weatherreport_\"..plugin.mainDeviceId,jsonTable.forecast.weatherreport)\n\n         if jsonTable then self:onWeatherDataReceived(jsonTable) end\n      end,\n      error = function(error)\n         self:error(\"error: \" ..json.encode(error))\n         self:updateProperty(\"log\", \"error: \" ..json.encode(error))\n      end\n  })   \n  fibaro.setTimeout(interval*1000, function() \n     self:getWeatherData()\n  end)\nend\n\n\n-- Get all weather data from json\nfunction QuickApp:onWeatherDataReceived(data)\n   -- Get the values from the stationid\n   for i in pairs(data.actual.stationmeasurements) do \n       --self:debug(jsonTable.actual.stationmeasurements[i].stationid ..\" \" ..data.actual.stationmeasurements[i].stationname)\n       if stationid == data.actual.stationmeasurements[i].stationid then\n\n          -- The main values\n          temperature = data.actual.stationmeasurements[i].temperature\n          humidity = data.actual.stationmeasurements[i].humidity\n          windspeed = data.actual.stationmeasurements[i].windspeed\n\n          -- The extra values\n          stationname = data.actual.stationmeasurements[i].stationname\n          weatherdescription = data.actual.stationmeasurements[i].weatherdescription\n\n         -- Save Station specific weather values to Global Variable\n          self:setGlobalVariable(\"Buienradar_Station_\"..plugin.mainDeviceId,data.actual.stationmeasurements[i])\n\n       end\n   end\n\n   -- Check if variables have a value\n   if stationname == \"\" or stationname == nil then\n      self:warning(\"error: Station \" ..stationid ..\" not found!\")\n   else \n      if temperature == \"\" or temperature == nil then\n         temperature = \"999\"\n      end\n      if humidity == \"\" or humidity == nil then\n         humidity = \"999\"\n      end\n      if windspeed == \"\" or windspeed == nil then\n         windspeed = \"999\"\n      end\n      if weatherdescription == \"\" or weatherdescription == nil then\n         weatherdescription = \"empty\"\n      end\n      self:setWeathercondition()\n      self:setPropertiesLables()\n   end\n\n   --self:debug(\"------ END ------\")\n\nend\n\n\n-- Update properties and labels \nfunction QuickApp:setPropertiesLables()\n   self:updateProperty(\"log\", stationname)\n   self:updateView(\"labelStationname\", \"text\", stationname ..\" (\" ..stationid ..\")\")\n\n   self:updateView(\"labelWeatherdescription\", \"text\", weatherdescription)\n   \n   self:updateProperty(\"Temperature\", temperature)\n   self:updateView(\"labelTemperature\", \"text\", \"Temperature: \" ..tostring(temperature) ..\" Â°C\")\n\n   self:updateProperty(\"Humidity\", humidity)\n   self:updateView(\"labelHumidity\", \"text\", \"Humidity: \" ..tostring(humidity) ..\" %\")\n\n   self:updateProperty(\"Wind\", windspeed)\n   self:updateView(\"labelWind\", \"text\", \"Wind: \" ..tostring(windspeed) ..\" m/s\")\n\n   self:debug(\"Station: \", stationname ..\" (\" ..stationid ..\")\" ..\" / Weatherdescription: \", weatherdescription ..\" / Temperature\", temperature ..\" / Humidity\", humidity .. \" / Wind\", windspeed)\n\nend\n\n\n-- Manage the QuickApp variables\nfunction QuickApp:getQuickAppVariables()\n   interval = tonumber(self:getVariable(\"Interval\")) \n   stationid = tonumber(self:getVariable(\"StationID\")) \n   timeout = tonumber(self:getVariable(\"Timeout\")) \n   setglobalvar = self:getVariable(\"SetGlobalVar\")\n\n   -- Check existence of the mandatory variables, if not, create them with default values \n   if interval == \"\" or interval == nil then\n      interval = \"601\" -- Default interval in seconds (Buienradar updates every 10 minutes)\n      self:setVariable(\"Interval\",interval)\n      self:trace(\"Added QuickApp variable Interval\")\n      interval = tonumber(interval)\n   end\n   if stationid == \"\" or stationid == nil then \n      stationid = \"6260\" -- Default station ID is 6260 (Meetstation De Bilt)\n      self:setVariable(\"StationID\",stationid)\n      self:trace(\"Added QuickApp variable StationID\")\n      stationid = tonumber(stationid)\n   end\n   if timeout == \"\" or timeout == nil then\n      timeout = \"5\" -- Default value for timeout response in seconds\n      self:setVariable(\"Timeout\",timeout)\n      self:trace(\"Added QuickApp variable Timeout\")\n      timeout = tonumber(timeout)\n   end\n   if setglobalvar == \"\" or setglobalvar == nil then \n      setglobalvar = false -- Default SetGlobalVar is falso (No use of Global Variables)\n      self:setVariable(\"SetGlobalVar\",tostring(setglobalvar))\n      self:trace(\"Added QuickApp variable SetGlobalVar\")\n   end\nend\n\n\nfunction QuickApp:onInit()\n   __TAG = \"BUIENRADAR_WEATHER_\"..plugin.mainDeviceId\n   self:debug(\"onInit\")  \n   self:getQuickAppVariables()  \n   http = net.HTTPClient({timeout=timeout})\n   self:getWeatherData()\nend\n\n"}]}